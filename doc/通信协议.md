### CAN通信协议总结

#### 1. 基本通信参数

*   **CAN ID (打印机 -> 送料柜)**: `0x10A`
    *   这个ID用于打印机向送料柜发送命令，如请求送料、查询状态、通知打印状态等。
*   **CAN ID (送料柜 -> 打印机)**: `0x10B`
    *   这个ID用于送料柜向打印机发送状态更新，如送料进度、错误代码等。
*   **通信方向**:
    *   **打印机 (本项目)** 作为主控方，主动发起命令。
    *   **送料柜** 作为从设备，响应命令并汇报自身状态。

#### 2. 握手协议

系统在建立CAN连接后，会首先进行握手，以确认双方在线且协议兼容。

*   **握手请求 (打印机 -> 送料柜)**
    *   **CAN ID**: `0x3F0`
    *   **数据**: `[0x01, 0xF0, 0x10, 0x00, 0x00, 0x06, 0x01, 0x05]`
*   **握手响应 (送料柜 -> 打印机)**
    *   **CAN ID**: `0x3F1`
    *   **数据**: `[0x05]` (一个字节，值为`0x05`表示成功)

#### 3. 主要命令 (打印机 -> 送料柜)

打印机通过发送CAN ID为 `0x10A` 的消息来下达命令。数据负载的第一个字节是**命令码**。

*   `0x01` (`CMD_REQUEST_FEED`): **请求送料**
*   `0x02` (`CMD_STOP_FEED`): **停止送料**
*   `0x03` (`CMD_QUERY_STATUS`): **查询状态**
*   `0x04` (`CMD_PRINTING`): 通知送料柜**打印正在进行**
*   `0x05` (`CMD_PRINT_COMPLETE`): 通知送料柜**打印完成**
*   `0x06` (`CMD_PRINT_PAUSE`): 通知送料柜**打印暂停**
*   `0x07` (`CMD_PRINT_CANCEL`): 通知送料柜**打印取消**
*   `0x08` (`CMD_PRINTER_IDLE`): 通知送料柜**打印机空闲**
*   `0x09` (`CMD_PRINTER_ERROR`): 通知送料柜**打印机出错**
*   `0x0A` (`CMD_HEARTBEAT`): **心跳包**，用于维持连接
*   `0x0B` (`CMD_LOAD_FILAMENT`): **进料**
*   `0x0C` (`CMD_UNLOAD_FILAMENT`): **退料**
*   `0x0E` (`CMD_PRINTER_FILAMENT_STATUS_RESPONSE`): **打印机响应挤出机余料状态**

#### 4. 状态响应 (送料柜 -> 打印机)
*   `0x0D` (`CMD_QUERY_PRINTER_FILAMENT_STATUS`): **送料柜查询挤出机余料状态**

送料柜通过发送CAN ID为 `0x10B` 的消息来上报其内部状态。

*   **数据格式 (3字节)**:
    *   `Byte 0`: **状态码**
        *   `0x00`: 空闲 (`STATUS_IDLE`)
        *   `0x01`: 就绪/准备送料 (`STATUS_READY`)
        *   `0x02`: 送料中 (`STATUS_FEEDING`)
        *   `0x03`: 完成 (`STATUS_COMPLETE`)
        *   `0x04`: 错误 (`STATUS_ERROR`)
    *   `Byte 1`: **进度** (0-100)
    *   `Byte 2`: **错误码**
        *   `0x00`: 无错误
        *   `0x01`: 机械错误
        *   `0x02`: 材料缺失
        *   等等...

---