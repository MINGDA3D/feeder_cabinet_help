1. 系统整体架构：
   - 打印机主控通过 Klipper 与自动续料模块通信
   - 自动续料模块通过 CAN 总线与送料柜控制器通信
   - 整个系统分为打印机系统和送料柜系统两大部分

2. 通信协议：
   - 使用 CAN 总线通信，波特率 1000000
   - 打印机发送消息 ID：0x10A
   - 送料柜回复消息 ID：0x10B
   - 握手过程：
     - 打印机发送：ID 0x3F0，数据 [01 F0 10 00 00 06 01 05]
     - 送料柜回复：ID 0x3F1，数据 [05]

3. 消息格式：
   - 发送消息（打印机 -> 送料柜）：
     - Byte 0：命令类型（请求补料、停止补料、状态查询等）
     - Byte 1：序列号（1-255循环）
     - Byte 2：挤出头编号
     - Byte 3-7：预留
   
   - 接收消息（送料柜 -> 打印机）：
     - Byte 0：状态码（空闲、准备送料、送料中等）
     - Byte 1：进度（0-100）
     - Byte 2：错误码
     - Byte 3-7：预留

4. 工作机制：
   - 每 5 秒获取一次 Klipper 状态，状态变化时通过 CAN 发送给送料柜
   - 每 30 秒发送一次心跳包检测送料柜是否在线
   - 支持自动续料流程：检测耗材用尽 -> 暂停打印 -> 请求补料 -> 等待送料 -> 检测新耗材 -> 恢复打印

5. 错误处理：
   - 支持多种错误类型：通信错误、机械错误等
   - 错误发生时：记录日志 -> 通知用户 -> 停止操作 -> 等待处理 -> 恢复空闲状态

6. 用户交互：
   - 提供 G-code 命令：START_FEEDER_CABINET、QUERY_FEEDER_CABINET、CANCEL_FEEDER_CABINET
   - 支持状态查询，返回当前状态、进度和错误信息

7. 运行环境：
   - 打印机固件：Klipper
   - 控制板系统：Debian 11
   - 编程语言：Python
   - 需要自行实现 CAN 通信模块

8. 安全机制：
   - 状态检查：验证打印机、送料柜和传感器状态
   - 操作保护：防止重复操作，验证状态合法性，超时保护
   - 系统保护：保护打印任务，机械保护，异常恢复

