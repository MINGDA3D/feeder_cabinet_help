```mermaid
graph TD
    A[开始] --> B[检测到耗材用尽]
    B --> C[暂停打印]
    C --> D[保存打印状态]
    D --> E[发送补料请求到送料柜]
    
    E --> F{送料柜响应?}
    F -->|是| G[开始送料]
    F -->|否| H[记录错误]
    
    G --> I{检测到新耗材?}
    I -->|是| J[发送完成信号]
    I -->|否| K[等待新耗材]
    K --> I
    
    J --> L[恢复打印状态]
    L --> M[继续打印]
    M --> N[结束]

    
    %% 添加心跳检测
    subgraph 心跳检测
        X[每30秒]
        X --> Y[发送心跳包]
        Y --> Z{送料柜在线?}
        Z -->|是| X
        Z -->|否| H
    end
    
    %% 添加状态监控
    subgraph 状态监控
        S1[实时]
        S1 --> S2[获取Klipper状态]
        S2 --> S3{状态变化?}
        S3 -->|是| S4[发送状态到送料柜]
        S3 -->|否| S1
        S4 --> S1
    end
```

这个流程图展示了：

1. 主要流程：
   - 检测耗材用尽
   - 暂停打印并保存状态
   - 发送补料请求
   - 等待送料柜响应
   - 监测新耗材
   - 恢复打印

2. 错误处理：
   - 送料柜无响应处理
   - 错误记录和用户通知
   - 错误恢复流程

3. 并行监控：
   - 心跳检测（每30秒）
   - 状态监控（每5秒）

4. 状态转换：
   - 正常流程的状态转换
   - 错误情况的状态转换
   - 恢复流程的状态转换

这个流程确保了：
- 打印过程的连续性
- 系统状态的实时监控
- 错误的及时处理
- 用户的及时通知
- 自动恢复的可能性
